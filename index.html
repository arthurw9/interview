<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="style.css?q=3">
<script>
var LoadScript = function(path) {
  var url = path + "?z=" + Math.random();
  var script = document.createElement("script");
  script.src = url;
  document.head.appendChild(script);
  console.log("loading", url);
}
LoadScript("interview.js");
</script>
<script>
function AdjustHeight(obj) {
  var height = obj.style.height;
  var idx = 0;
  while (/[0-9]/.test(height[idx])) idx += 1;
  height = Number(height.substr(0, idx));
  if (height < obj.scrollHeight) {
    obj.style.height=obj.scrollHeight + "px";
  }
}
function OldRender() {
  var text=document.getElementById("definition").value;
  var model = Parse(text);
  RunModel(model);
  var str = "";
  for (var key in model.data) {
    str += key + ": " + model.data[key] + "<br>";
  }
  str += "<hr>";
  model = Parse(text);  // Resets all state.
  var idx = 0;
  while (idx < model.expression_list.length) {
    var expr = model.expression_list[idx].expression;
    str += ExpressionDebugString(model, expr) + " : " + Evaluate(model, expr) +
           "<br>"; 
    ++idx;
  }
  var interview = document.getElementById("interview");
  interview.innerHTML = str;
  return 1;
}
function Render() {
  var text=document.getElementById("definition").value;
  var model = Parse(text);
  window.model = model;
  var interview = document.getElementById("interview");
  RenderModel(model, interview);
  return 1;
}

function Initialize() {
  var str =   "form US1040\n" +
    "page start\n" +
    "message \"You are at the start. What is going on?\"\n" +
    "\n" +
    "page page2\n" +
    "message \"You are at page2.\"\n" +
    "\n" +
    "page page3\n" +
    "message \"You are at page3.\"\n" +
    "\n" +
    "form worksheet1\n" +
    "page w1p1\n" +
    "message \"I am here.\"\n" +
    "\n" +
    "page w1p2\n" +
    "message \"Are you here?\"\n";
  document.getElementById("definition").value = str;
}
function ConvertToJsString() {
  var text=document.getElementById("definition").value;
  var str = "<pre>var str = ";
  var lines = text.split("\n");
  var n = lines.length;
  while (lines[n-1] == "") {
    --n;
  }
  var i = 0;
  while (i < n) {
    var line = lines[i];
    line = line.split("\"").join("\\\"");
    if (i != 0) {
      str += " +\n";
    }
    str += "  \"" + line + "\\n\"";
    i++;
  }
  str += ";\n</pre>";
  var interview = document.getElementById("interview");
  interview.innerHTML = str;
  return 1;
}
</script>
</head>
<body>
<h1>Forms!</h1>
<a href="test.html">Unit test file</a>
<div class=flex id=outer>
<div class=flex>
<form>
Interview Definition<br>
<textarea id=definition style="width: 290px;"
  onfocus='AdjustHeight(this);'
  oninput='AdjustHeight(this);'>
/* stuff */
a = "yes";
y = "no";
z = 1 + 3 * 4 / (1 + 1);
x = 8;
x;
x = x + 1;
x;
</textarea><br>
<button type="button" onclick="Initialize();">Initialize</button>
<button type="button" onclick="ConvertToJsString();">Convert to Js string</button>
<button type="button" onclick="OldRender();">Old Render</button>
<button type="button" onclick="Render();">Render</button>
</form>
</div>
<div class=flex>
<form id=interview>
</form>
</div>
</div>
</body>
</html>

